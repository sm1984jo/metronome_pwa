<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>메트로놈</title>
  <style>
    :root{--bg:#0f1218;--card:#151a22;--fg:#e8eef9;--sub:#9fb0c7;--accent:#66d9ef}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 70% -10%,#1a2230,transparent),var(--bg);color:var(--fg)}
    .wrap{max-width:840px;margin:24px auto;padding:24px;padding-bottom:calc(env(safe-area-inset-bottom) + 24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{font-size:22px;margin:0;font-weight:700}
    .card{background:var(--card);border:1px solid #232a36;border-radius:14px;padding:18px}
    .controls{display:grid;grid-template-columns:1fr;gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:#1f2a3a;color:var(--fg);font-weight:700;cursor:pointer;transition:.15s;box-shadow:0 0 0 1px #2a3445 inset}
    .btn.good{background:#1f3a2a;box-shadow:0 0 0 1px #2e5f46 inset}
    .btn.warn{background:#3a2d1f;box-shadow:0 0 0 1px #6a4e2b inset}
    .btn.ghost{background:#1a2130}
    .big{font-size:34px;line-height:1;font-variant-numeric:tabular-nums}
    .sub{color:var(--sub);font-size:12px}
    input[type="range"]{width:100%}
    .display{display:flex;align-items:center;justify-content:center;height:160px;margin:14px 0;border-radius:14px;border:1px solid #2a3445;background:linear-gradient(180deg,#162030,#101520)}
    .leds{display:flex;justify-content:center;gap:10px;margin-top:10px}
    .led{width:12px;height:12px;border-radius:50%;background:#2a3445;transition:.06s}
    .led.on{background:var(--accent);box-shadow:0 0 18px var(--accent)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9999}
    .sheet{background:#101725;border:1px solid #2a3445;border-radius:16px;padding:22px;max-width:420px;margin:20px;text-align:center}
    .sheet h2{margin:0 0 10px 0}
    .sheet p{margin:0 0 14px 0;color:var(--sub)}
    .sheet .btn{width:100%;font-size:18px}
  </style>
</head>
<body>
  <div class="overlay" id="unlockOverlay">
    <div class="sheet">
      <h2>소리 활성화</h2>
      <p>iPhone 정책 때문에 먼저 한 번 눌러주세요.</p>
      <button class="btn" id="unlockBtn">소리 켜기</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1>메트로놈</h1>
      <div class="sub">홈 화면에 추가 → 앱처럼 사용 · 오프라인</div>
    </header>

    <div class="card">
      <div class="controls">
        <div>
          <label for="bpm">BPM</label>
          <div class="row">
            <button class="btn ghost" id="minus10">-10</button>
            <input id="bpm" type="range" min="20" max="300" value="100" step="1" />
            <button class="btn ghost" id="plus10">+10</button>
          </div>
          <div class="row">
            <div class="big" id="bpmDisplay">100</div>
            <button class="btn" id="tapBtn">탭 템포</button>
            <button class="btn" id="nudgeDown">-</button>
            <button class="btn" id="nudgeUp">+</button>
          </div>
          <div class="row sub" id="tapInfo">T 키 또는 버튼을 3–6번 탭하세요.</div>
        </div>

        <div>
          <label>박자/악센트</label>
          <div class="row">
            <select id="beats" class="btn ghost">
              <option value="2">2/4</option>
              <option value="3">3/4</option>
              <option value="4" selected>4/4</option>
              <option value="5">5/4</option>
              <option value="6">6/8</option>
              <option value="7">7/8</option>
              <option value="9">9/8</option>
            </select>
            <select id="subdiv" class="btn ghost">
              <option value="1" selected>분할 없음</option>
              <option value="2">2분할</option>
              <option value="3">3분할</option>
              <option value="4">4분할</option>
            </select>
          </div>
          <div class="row">
            <label class="sub"><input type="checkbox" id="accentFirst" checked /> 첫 박자 악센트</label>
            <label class="sub"><input type="checkbox" id="swing" /> 스윙(재즈)</label>
          </div>
          <div class="row">
            <button class="btn good" id="startStop">시작</button>
            <button class="btn warn" id="reset">리셋</button>
          </div>
        </div>

        <div>
          <label>소리/표시</label>
          <div class="row">
            <select id="sound" class="btn ghost">
              <option value="click" selected>클릭</option>
              <option value="wood">우드블록</option>
              <option value="beep">비프</option>
            </select>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9" />
          </div>
          <div class="row">
            <label class="sub"><input type="checkbox" id="visual" checked /> 화면 플래시</label>
          </div>
        </div>
      </div>

      <div class="display" id="display">
        <div class="big" id="beatText">1</div>
      </div>
      <div class="leds" id="leds"></div>
    </div>
  </div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

(() => {
  const $ = s => document.querySelector(s);
  const unlockOverlay = $('#unlockOverlay');
  const unlockBtn = $('#unlockBtn');
  let audioCtx, unlocked = false;

  function unlockAudio(){
    if (unlocked) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
    const buffer = audioCtx.createBuffer(1,1,22050);
    const src = audioCtx.createBufferSource(); src.buffer = buffer; src.connect(audioCtx.destination); src.start(0);
    if (audioCtx.state === 'suspended') audioCtx.resume();
    unlocked = true; unlockOverlay.style.display = 'none';
  }
  ['touchstart','mousedown','keydown'].forEach(ev=>window.addEventListener(ev, ()=>{ if(!unlocked) unlockAudio(); }, {once:true, passive:true}));
  unlockBtn.addEventListener('click', unlockAudio);

  const bpmEl = $('#bpm'); const bpmDisplay = $('#bpmDisplay');
  const startStopBtn = $('#startStop'); const resetBtn = $('#reset');
  const tapBtn = $('#tapBtn'); const tapInfo = $('#tapInfo');
  const beatsEl = $('#beats'); const subdivEl = $('#subdiv');
  const accentFirstEl = $('#accentFirst'); const swingEl = $('#swing');
  const soundEl = $('#sound'); const volumeEl = $('#volume');
  const visualEl = $('#visual'); const display = $('#display');
  const beatText = $('#beatText'); const leds = $('#leds');
  const minus10 = $('#minus10'); const plus10 = $('#plus10');
  const nudgeUp = $('#nudgeUp'); const nudgeDown = $('#nudgeDown');

  let isRunning=false, currentBeat=0, nextNoteTime=0, scheduleTimer;
  let tapTimes=[], lastTap=0;
  const lookahead=25, scheduleAheadTime=0.1;

  function updateBpmDisplay(){ bpmDisplay.textContent = bpmEl.value; }
  function noteLengthSec(){ const bpm=+bpmEl.value; const base=60/bpm; const subdiv=+subdivEl.value; if(swingEl.checked&&subdiv===2) return base/2; return subdiv>1? base/subdiv: base; }

  function scheduleClick(time, isAccent, isSub){
    if(!audioCtx) return;
    const vol=+volumeEl.value;
    const osc=audioCtx.createOscillator();
    const env=audioCtx.createGain();
    let freq;
    const sound=soundEl.value;
    if(sound==='click'){ freq=isAccent?2000:(isSub?1500:1700);} 
    else if(sound==='wood'){ freq=isAccent?900:(isSub?650:750);} 
    else { freq=isAccent?1000:(isSub?700:850);}
    osc.frequency.value=freq; env.gain.value=0; osc.connect(env).connect(audioCtx.destination);
    const a=isAccent?0.002:0.003; const d=isAccent?0.06:0.04;
    env.gain.setValueAtTime(0,time); env.gain.linearRampToValueAtTime(vol,time+a); env.gain.exponentialRampToValueAtTime(0.0001,time+d);
    osc.start(time); osc.stop(time+d+0.02);
  }

  function flashVisual(ac){ if(!visualEl.checked) return; display.style.transform='scale(1.02)';
    display.style.boxShadow=ac?'0 0 40px rgba(102,217,239,.5)':'0 0 22px rgba(102,217,239,.25)';
    setTimeout(()=>{display.style.transform='scale(1)'; display.style.boxShadow='none';},60); }

  function updateLEDs(active,total){ leds.innerHTML=''; for(let i=0;i<total;i++){ const d=document.createElement('div'); d.className='led'+(i===active?' on':''); leds.appendChild(d);} }

  function scheduler(){ 
    while(audioCtx && nextNoteTime < audioCtx.currentTime + scheduleAheadTime){ 
      const beatsPerBar=+beatsEl.value; const subdiv=+subdivEl.value; 
      const beatIndex=currentBeat % beatsPerBar; 
      const isBarAccent=accentFirstEl.checked && beatIndex===0; 
      let stepsThisBeat=subdiv; if(subdiv===1) stepsThisBeat=1; 
      for(let s=0;s<stepsThisBeat;s++){ 
        const isSub=(s!==0); const isAccent=isBarAccent && s===0; 
        scheduleClick(nextNoteTime,isAccent,isSub); 
        if(s===0){ setTimeout(((accent,beatNo)=>()=>{ 
          beatText.textContent=(beatNo+1); updateLEDs(beatNo,beatsPerBar); flashVisual(accent); 
        })(isAccent,beatIndex), Math.max(0,(nextNoteTime - audioCtx.currentTime)*1000 - 8)); } 
        let stepLen=noteLengthSec(); if(swingEl.checked && subdiv===2){ stepLen = s===0 ? stepLen*2/3 : stepLen*1/3; } 
        nextNoteTime += stepLen; 
      } 
      currentBeat = (currentBeat + 1) % beatsPerBar; 
    } 
  }

  function start(){ 
    if(!unlocked) unlockAudio(); 
    if(isRunning) return; 
    isRunning=true; startStopBtn.textContent='정지'; 
    const beatsPerBar=+beatsEl.value; updateLEDs(0,beatsPerBar); 
    currentBeat=0; nextNoteTime = audioCtx.currentTime + 0.08; 
    scheduleTimer = setInterval(scheduler, lookahead); 
  }

  function stop(){ isRunning=false; startStopBtn.textContent='시작'; if(scheduleTimer) clearInterval(scheduleTimer); }
  function reset(){ stop(); tapTimes=[]; beatText.textContent='1'; updateLEDs(0, +beatsEl.value); }

  startStopBtn.addEventListener('click', ()=> isRunning? stop() : start());
  resetBtn.addEventListener('click', reset);
  bpmEl.addEventListener('input', updateBpmDisplay);
  minus10.addEventListener('click', ()=>{ bpmEl.value=Math.max(20, +bpmEl.value-10); updateBpmDisplay(); });
  plus10.addEventListener('click', ()=>{ bpmEl.value=Math.min(300, +bpmEl.value+10); updateBpmDisplay(); });
  nudgeUp.addEventListener('click', ()=>{ bpmEl.value=Math.min(300, +bpmEl.value+1); updateBpmDisplay(); });
  nudgeDown.addEventListener('click', ()=>{ bpmEl.value=Math.max(20, +bpmEl.value-1); updateBpmDisplay(); });

  // Tap tempo
  function onTap(){ const now=performance.now(); if(lastTap && (now-lastTap)>1500) tapTimes=[]; tapTimes.push(now); lastTap=now; 
    if(tapTimes.length>=3){ const ints=[]; for(let i=1;i<tapTimes.length;i++){ ints.push(tapTimes[i]-tapTimes[i-1]); } 
      ints.sort((a,b)=>a-b); let use=ints.slice(); if(ints.length>=4) use=ints.slice(1,-1); 
      const avg=use.reduce((a,b)=>a+b,0)/use.length; const bpm=Math.max(20, Math.min(300, Math.round(60000/avg))); 
      bpmEl.value=bpm; updateBpmDisplay(); tapInfo.textContent=`탭 기반 BPM ≈ ${bpm}`; } 
    else { tapInfo.textContent = `${tapTimes.length}회 탭됨…`; } }
  tapBtn.addEventListener('click', onTap);

  updateBpmDisplay(); updateLEDs(0, +beatsEl.value);
})();
</script>
</body>
</html>